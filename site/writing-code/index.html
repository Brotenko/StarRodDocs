<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Writing Code - StarRod Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Writing Code";
    var mkdocs_page_input_path = "writing-code.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> StarRod Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Getting Started</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../writing-patch-files/">Writing Patch Files</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../writing-scripts/">Writing Scripts</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Writing Code</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#assembly">Assembly</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pseudo-instructions">Pseudo-Instructions</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#convenience">Convenience</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#loadstore-address">Load/Store Address</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#loadstore-table">Load/Store Table</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stack-operations">Stack Operations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#branch-conditions">Branch Conditions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#special">Special</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#loops">Loops</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#for-loops">For-Loops</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#while-loops">While-Loops</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#register-naming">Register Naming</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#check-if-a-badge-is-equipped">Check if a badge is equipped</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#writing-a-script-callable-function">Writing a Script-Callable Function</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../using-strings/">Using Strings</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../globals/">Globals</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../icons/">Icons</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../editing-items/">Editing Items</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../editing-sprites/">Editing Sprites</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../maps/">Maps</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../battles/">Battles</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../engine-limits/">Engine Limits</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../the-debug-menu/">The Debug Menug</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../command-line-interface/">Command Line Interface</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">StarRod Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Writing Code</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="writing-code">Writing Code<a class="headerlink" href="#writing-code" title="Permanent link">#</a></h1>
<h2 id="assembly">Assembly<a class="headerlink" href="#assembly" title="Permanent link">#</a></h2>
<p>The N64 uses the NEC VR4300 CPU, closely related to the MIPS R4300i. As such, the compiled machine code in Paper Mario can be disassembled into MIPS assembly language. Star Rod uses a custom MIPS assembler/disassembler to convert between machine code on the ROM and a (more) user-friendly assembly language.</p>
<p>As functions are dumped from the ROM, branches and jump tables are recognized and appropriate labels are created for their destinations. You can use labels as branch targets in your own code. You can also reference pointers (e.g. <code>$Script_Example</code>), script variables (e.g. <code>*StoryProgress</code>), and special functions (e.g. <code>{Func:GetVariable}</code>).</p>
<p><strong><em>Note:</em></strong> Register 30 may be referenced as either S8 or FP. Both are accepted.</p>
<h2 id="pseudo-instructions">Pseudo-Instructions<a class="headerlink" href="#pseudo-instructions" title="Permanent link">#</a></h2>
<p>During the dump, certain sequences of instructions are replaced by pseudo-instructions (PIs) to help find pointers and data structures that would otherwise be 'hidden' within functions. In this way, relocated data structures can have their pointers properly updated. You are encouraged to use these pseudo-instructions in your own code to improve readability and reduce errors.</p>
<p><strong><em>Note:</em></strong> Don't worry about the distinction between LIA and LIO. For reversibility only.</p>
<h3 id="convenience">Convenience<a class="headerlink" href="#convenience" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLEAR X</td>
<td>Set X = 0. Equivalent to DADDU X, R0, R0</td>
</tr>
<tr>
<td>COPY X, Y</td>
<td>Set X = Y. Equivalent to DADDU X, Y, R0</td>
</tr>
<tr>
<td>SUBI X, Y, 1234</td>
<td>Subtracts an immediate value.</td>
</tr>
<tr>
<td>SUBIU X, Y, 1234</td>
<td>Subtracts an immediate value (unsigned).</td>
</tr>
<tr>
<td>LIA   X, 12345678</td>
<td>Load a constant word to register (ADD variant).</td>
</tr>
<tr>
<td>LIO   X, 12345678</td>
<td>Load a constant word to register (OR variant).</td>
</tr>
<tr>
<td>LIF   FX, 3.25</td>
<td>Load a constant float to COP1 register.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="loadstore-address">Load/Store Address<a class="headerlink" href="#loadstore-address" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>LAB    X, ADDR</td>
<td>Load a byte from ADDR to register.</td>
</tr>
<tr>
<td>LABU   X, ADDR</td>
<td>Load an unsigned byte from ADDR to register.</td>
</tr>
<tr>
<td>SAB    X, ADDR</td>
<td>Store a byte from register to ADDR.</td>
</tr>
<tr>
<td>LAH    X, ADDR</td>
<td>Load a half-word from ADDR to register.</td>
</tr>
<tr>
<td>LAHU   X, ADDR</td>
<td>Load an unsigned half-word from ADDR to register.</td>
</tr>
<tr>
<td>SAH    X, ADDR</td>
<td>Store a half-word from register to ADDR.</td>
</tr>
<tr>
<td>LAW    X, ADDR</td>
<td>Load a word from ADDR to register.</td>
</tr>
<tr>
<td>SAW    X, ADDR</td>
<td>Store a word from register to ADDR.</td>
</tr>
<tr>
<td>LAF    FX, ADDR</td>
<td>Load a float from ADDR to COP1 register.</td>
</tr>
<tr>
<td>SAF    FX, ADDR</td>
<td>Store a float from COP1 register to ADDR.</td>
</tr>
<tr>
<td>LAD    FX, ADDR</td>
<td>Load a double float from ADDR to COP1 register.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="loadstore-table">Load/Store Table<a class="headerlink" href="#loadstore-table" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>LTB    X, Y (ADDR)</td>
<td>Load the Yth byte from ADDR to X.</td>
</tr>
<tr>
<td>LTBU   X, Y (ADDR)</td>
<td>Load the Yth unsigned byte from ADDR to X.</td>
</tr>
<tr>
<td>LTH    X, Y (ADDR)</td>
<td>Load the Yth half-word from ADDR to X.</td>
</tr>
<tr>
<td>LTHU   X, Y (ADDR)</td>
<td>Load the Yth unsigned half-word from ADDR to X.</td>
</tr>
<tr>
<td>LTW    X, Y (ADDR)</td>
<td>Load the Yth word from ADDR to X.</td>
</tr>
<tr>
<td>LTF    FX, Y (ADDR)</td>
<td>Load the Yth float from ADDR to COP1 register FX.</td>
</tr>
<tr>
<td>STB    X, Y (ADDR)</td>
<td>Store X at the Yth byte from ADDR.</td>
</tr>
<tr>
<td>STH    X, Y (ADDR)</td>
<td>Store X at the Yth half-word from ADDR.</td>
</tr>
<tr>
<td>STW    X, Y (ADDR)</td>
<td>Store X at the Yth word from ADDR.</td>
</tr>
<tr>
<td>STF    FX, Y (ADDR)</td>
<td>Store X at the Yth float from ADDR.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="stack-operations">Stack Operations<a class="headerlink" href="#stack-operations" title="Permanent link">#</a></h3>
<p>Standard MIPS calling conventions require functions to preserve the values of certain registers when they are called. These values are saved to the stack at the beginning of the function and restored at the end. To minimize the opportunity for errors, Star Rod introduces several simple pseudo-instructions for these stack operations: PUSH, POP, and JPOP (identical to POP + JR RA + NOP). You can use these with multiple registers, but be sure to list the same registers in the same order for both.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>PUSH  X, Y, ...</td>
<td>Push a list of registers onto the stack, starting at SP[10]. Updates the stack pointer accordingly, padded to 8-byte alignment as needed.</td>
</tr>
<tr>
<td>POP   X, Y, ...</td>
<td>Restores registers from the stack. Order is important! Use the same list as the corresponding push. Updates the stack pointer.</td>
</tr>
<tr>
<td>JPOP  X, Y, ...</td>
<td>Identical to POP followed by JR RA. Stack addition is done in the delay slot of the JR, so this does not need to be followed by a NOP.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="branch-conditions">Branch Conditions<a class="headerlink" href="#branch-conditions" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>BLT   X, Y</td>
<td>Branch if X &lt; Y.</td>
</tr>
<tr>
<td>BGT   X, Y</td>
<td>Branch if X &gt; Y.</td>
</tr>
<tr>
<td>BLE   X, Y</td>
<td>Branch if X &lt;= Y.</td>
</tr>
<tr>
<td>BGE   X, Y</td>
<td>Branch if X &gt;= Y.</td>
</tr>
<tr>
<td>BLTL/BGTL/BLEL/BGEL</td>
<td>Branch “likely” variants.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="special">Special<a class="headerlink" href="#special" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RESERVED</td>
<td>Put this in a delay slot following a PI and a jump to force the final instruction of the compiled PI to occupy the delay slot.</td>
</tr>
</tbody>
</table>
<p><br></p>
<h2 id="loops">Loops<a class="headerlink" href="#loops" title="Permanent link">#</a></h2>
<p>Loops can be created using the <code>LOOP</code> and <code>ENDLOOP</code> pseudo-instruction. Instructions between them become the body of the loop. Labels and branching logic are created automatically and only a single register is required for the loop index value. You may also exit the loop at any time from within its body with the <code>BREAKLOOP</code> pseudo-instruction.</p>
<h3 id="for-loops">For-Loops<a class="headerlink" href="#for-loops" title="Permanent link">#</a></h3>
<pre><code class="text">LOOP     index = start,step,end
...
ENDLOOP
</code></pre>

<p>This loop will initialize the value of a register <strong>(index)</strong> to <strong>start</strong> and increment it by <strong>step</strong> at the end of each iteration until it equals or exceeds <strong>end</strong>. The condition is also checked before the first iteration. index can be any register, the other three can be any register or any 16-bit immediate integer value. Setting <strong>step</strong> to a negative value creates a decrementing loop. Omitting <strong>step</strong> defaults to a value of +1. If a register is used for <strong>step</strong> or <strong>end</strong>, you should avoid modifying their values in the loop body.</p>
<p>For loop examples:</p>
<pre><code class="text">LOOP        A0 = 0,5
Executes body with A0 = 0,1,2,3,4
</code></pre>

<pre><code class="text">LOOP        T1 = 1,2,10
Executes body with T1 = 1,3,5,7,9
</code></pre>

<pre><code class="text">LOOP        SP = SP,4,T4
Executes body, incrementing SP by 4 until it equals or exceeds T4.
</code></pre>

<h3 id="while-loops">While-Loops<a class="headerlink" href="#while-loops" title="Permanent link">#</a></h3>
<pre><code class="text">LOOP  index &lt; value
...
ENDLOOP
</code></pre>

<p>This loop will execute the body so long as the condition is true. The condition is checked prior to each iteration. <strong>index</strong> may be any register and <strong>value</strong> may be a register or a 16-bit immediate value. There are six valid options for the comparison test: &gt;, &gt;=, &lt;, &lt;=, ==, !=</p>
<p>While loop examples:</p>
<pre><code class="text">LOOP        A0 &lt; 10`
LOOP        T0 != T1
LOOP        S4 &gt; 0
</code></pre>

<h2 id="register-naming">Register Naming<a class="headerlink" href="#register-naming" title="Permanent link">#</a></h2>
<p>Registers can be assigned names with <code>#DEF</code> and reverted to their default names with <code>#UNDEF</code>. For example:</p>
<pre><code class="text">#DEF   A0, *Counter
CLEAR  *Counter
ADDIU  *Counter, *Counter, 1
ADDIU  *Counter, *Counter, 1
#UNDEF A0
COPY   A1, A0
</code></pre>

<p>In this example, <code>A0</code> may only be referred to as <code>*Counter</code> until the name is cleared by <code>#UNDEF</code>.</p>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">#</a></h2>
<h3 id="check-if-a-badge-is-equipped">Check if a badge is equipped<a class="headerlink" href="#check-if-a-badge-is-equipped" title="Permanent link">#</a></h3>
<pre><code class="text">% in:  A0 = badge ID to check for
% out: V0 = 1 if badge equipped, 0 if not
#DEF    A0, *BadgeID
PUSH    S0, S1             % Push saved registers to stack
LIO     S0, 8010F498       % Initialize loop start
ADDIU   S1, S0, 80         % 0x40 badge slots
LOOP    S0 = S0:2:S1
    LHU     V1, 0 (S0)
    BEQL    V1, *BadgeID, .Done
    ADDIU   V0, R0, 1      % Return TRUE
ENDLOOP
CLEAR   V0                 % Return FALSE
.Done
JPOP    S0, S1             % Pop saved registers from stack
</code></pre>

<h2 id="writing-a-script-callable-function">Writing a Script-Callable Function<a class="headerlink" href="#writing-a-script-callable-function" title="Permanent link">#</a></h2>
<p>Functions intended to be called by scripts using the <code>Call</code> command must follow certain rules to operate correctly. Your function must return a value from the <code>eCommandResult</code> enum (detailed below). Most functions will return <code>eScriptContinue</code>, indicating the script should resume execution after the function is complete. Return 0 instead if you’d like to block the script and have it call your function every frame until some task is finished or condition is met.</p>
<p>You may use the int[4] array at <code>(script_context + 0x70)</code> to store temporary values between repeated calls if you don’t want to modify the script variables.</p>
<p><strong>Valid return values:</strong> <br>
<strong>FF</strong>    eScriptYield    Script will stop executing (until next frame) <br>
<strong>&lt;0</strong>    ???            script returns 1 <br>
<strong>0 </strong>   eScriptBlock    Script will not proceed any further this frame <br>
<strong>1</strong>    ???            script returns 0 <br>
<strong>2 </strong>   eScriptContinue     <br>
<strong>3</strong>    eScriptRepeat     <br></p>
<p><strong>Arguments:</strong> <br>
<strong>A0</strong>     pointer to the script_context data structure of the caller <br>
<strong>A1</strong>    isInitialCall boolean, true on the first call, false on subsequent ones <br>
<strong>A2</strong>    address of the callee function <br>
<strong>S0</strong>    pointer to the function argument list in the script <br>
<strong>S1 </strong>   duplicate of A0 <br></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../using-strings/" class="btn btn-neutral float-right" title="Using Strings">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../writing-scripts/" class="btn btn-neutral" title="Writing Scripts"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../writing-scripts/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../using-strings/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
